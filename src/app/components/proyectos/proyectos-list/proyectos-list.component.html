<div class="proyectos-container">
  <div class="page-header">
    <div class="header-title">
      <img src="assets/umbrella-logo.png" alt="Umbrella Corporation" class="umbrella-icon" width="48" height="48" onerror="this.style.display='none'">
      <h1>UMBRELLA - Gestión de Proyectos</h1>
      <p class="subtitle">Sistema de Control y Seguimiento</p>
    </div>
    <button routerLink="/dashboard/nuevo-proyecto" class="btn btn-primary">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"/>
      </svg>
      Nuevo Proyecto
    </button>
  </div>

  <!-- Búsqueda Avanzada -->
  <div class="search-section">
    <div class="search-header">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"/>
      </svg>
      <h3>Búsqueda Avanzada</h3>
    </div>
    <div class="search-compact-grid">
      <div class="search-field">
        <label>Título</label>
        <input
          type="text"
          [(ngModel)]="searchTitulo"
          (input)="onSearchChange()"
          placeholder="Buscar...">
      </div>
      <div class="search-field">
        <label>Trabajador</label>
        <div class="custom-search-wrapper">
          <select
            [(ngModel)]="searchTrabajador"
            (change)="onSearchChange()"
            class="custom-search-select">
            <option value="">Todos los trabajadores</option>
            <option *ngFor="let trabajador of getTrabajadoresUnicos()"
                    [value]="trabajador">
              {{ trabajador }}
            </option>
          </select>
          <div class="search-select-arrow">
            <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"/>
            </svg>
          </div>
        </div>
      </div>
      <div class="search-field">
        <label>Fecha</label>
        <input
          type="text"
          [(ngModel)]="searchFecha"
          (input)="onSearchChange()"
          placeholder="dd/mm/yyyy">
      </div>
      <div class="search-actions">
        <button (click)="limpiarBusqueda()" class="btn-clear">
          <svg width="18" height="18" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
          </svg>
          Limpiar
        </button>
      </div>
    </div>
  </div>

  <!-- Filtros -->
  <div class="filters-container">
    <div class="filter-block">
      <h3>Filtrar por estado:</h3>
      <div class="filter-buttons">
        <button
          *ngFor="let estado of estadosFiltro"
          (click)="filterByEstado(estado)"
          [class.active]="filtroEstado === estado"
          [ngClass]="'filter-btn ' + getEstadoBadgeClass(estado)">
          {{ estado.replace('_', ' ') }}
        </button>
        <button
          *ngIf="filtroEstado"
          (click)="filterByEstado('')"
          class="filter-btn filter-clear">
          ✕ Limpiar
        </button>
      </div>
    </div>

    <div class="filter-block">
      <h3>Mostrar:</h3>
      <div class="filter-buttons">
        <button
          (click)="cambiarFiltroRegistro('TODOS')"
          [class.active]="filtroRegistro === 'TODOS'"
          class="filter-btn">
          Todos ({{ getContadorTotal() }})
        </button>
        <button
          (click)="cambiarFiltroRegistro('ACTIVO')"
          [class.active]="filtroRegistro === 'ACTIVO'"
          class="filter-btn badge-success">
          Activos ({{ getContadorActivos() }})
        </button>
        <button
          (click)="cambiarFiltroRegistro('INACTIVO')"
          [class.active]="filtroRegistro === 'INACTIVO'"
          class="filter-btn badge-inactive">
          Inactivos ({{ getContadorInactivos() }})
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="isLoading" class="loading">
    <div class="spinner"></div>
    <p>Cargando proyectos...</p>
  </div>

  <div *ngIf="!isLoading && proyectosFiltrados.length === 0" class="empty-state">
    <svg width="120" height="120" viewBox="0 0 120 120" fill="none">
      <circle cx="60" cy="60" r="50" fill="#e5e7eb"/>
      <path d="M40 50 L80 50 M40 60 L80 60 M40 70 L70 70" stroke="#9ca3af" stroke-width="4" stroke-linecap="round"/>
    </svg>
    <h3>No hay proyectos {{ filtroEstado ? 'con el estado ' + filtroEstado : 'registrados' }}</h3>
    <p>Comienza creando un nuevo proyecto</p>
  </div>

  <div *ngIf="!isLoading && proyectosFiltrados.length > 0" class="table-container">
    <table class="proyectos-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Título</th>
          <th>Descripción</th>
          <th>Trabajadores</th>
          <th>Fecha Asignación</th>
          <th>Fecha Límite</th>
          <th>Estado Proyecto</th>
          <th>Estado Registro</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let proyecto of proyectosFiltrados" [class.inactive-row]="proyecto.estadoRegistro === 'INACTIVO'">
          <td>{{ proyecto.id }}</td>
          <td class="title-cell">{{ proyecto.titulo }}</td>
          <td class="desc-cell">{{ proyecto.descripcion }}</td>
          <td>
            <div class="trabajadores-chips" *ngIf="(proyecto.trabajadores?.length || 0) > 0; else noTrabajadores">
              <div class="trabajador-chip" *ngFor="let trabajador of (proyecto.trabajadores | slice:0:2)" title="{{ trabajador.nombre }} {{ trabajador.apellido }} - {{ trabajador.cargo }}">
                <span class="chip-avatar">{{ trabajador.nombre.charAt(0) }}{{ trabajador.apellido.charAt(0) }}</span>
                <span class="chip-name">{{ trabajador.nombre }} {{ trabajador.apellido }}</span>
              </div>
              <div class="trabajador-chip chip-more" *ngIf="(proyecto.trabajadores?.length || 0) > 2">
                +{{ (proyecto.trabajadores?.length || 0) - 2 }}
              </div>
            </div>
            <ng-template #noTrabajadores>
              <div class="trabajadores-chips" *ngIf="proyecto.trabajador">
                <div class="trabajador-chip" title="{{ proyecto.trabajador.nombre }} {{ proyecto.trabajador.apellido }} - {{ proyecto.trabajador.cargo }}">
                  <span class="chip-avatar">{{ proyecto.trabajador.nombre.charAt(0) }}{{ proyecto.trabajador.apellido.charAt(0) }}</span>
                  <span class="chip-name">{{ proyecto.trabajador.nombre }} {{ proyecto.trabajador.apellido }}</span>
                </div>
              </div>
              <div *ngIf="!proyecto.trabajador" class="no-trabajador">
                <span style="color: #9ca3af; font-style: italic;">Sin asignar</span>
              </div>
            </ng-template>
          </td>
          <td>{{ proyecto.fechaAsignacion }}</td>
          <td>{{ proyecto.fechaLimite }}</td>
          <td>
            <span class="badge" [ngClass]="getEstadoBadgeClass(proyecto.estado)">
              {{ proyecto.estado.replace('_', ' ') }}
            </span>
          </td>
          <td>
            <span class="badge" [ngClass]="getEstadoRegistroBadgeClass(proyecto.estadoRegistro)">
              {{ proyecto.estadoRegistro }}
            </span>
          </td>
          <td class="actions-cell">
            <button (click)="viewDetails(proyecto)" class="btn-icon btn-info" title="Ver Detalles">
              <svg width="18" height="18" viewBox="0 0 18 18" fill="currentColor">
                <path d="M9 4.5a4.5 4.5 0 100 9 4.5 4.5 0 000-9zM3.5 9a5.5 5.5 0 1111 0 5.5 5.5 0 01-11 0z"/>
                <path d="M9 7a2 2 0 100 4 2 2 0 000-4z"/>
              </svg>
            </button>
            <button (click)="openAssignModal(proyecto)" class="btn-icon btn-success" title="Asignar Trabajador">
              <svg width="18" height="18" viewBox="0 0 18 18" fill="currentColor">
                <path fill-rule="evenodd" d="M9 3a1 1 0 011 1v4h4a1 1 0 110 2h-4v4a1 1 0 11-2 0v-4H4a1 1 0 110-2h4V4a1 1 0 011-1z" clip-rule="evenodd"/>
              </svg>
            </button>
            <button (click)="editProyecto(proyecto)" class="btn-icon btn-warning" title="Editar">
              <svg width="18" height="18" viewBox="0 0 18 18" fill="currentColor">
                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z"/>
              </svg>
            </button>
            <button
              *ngIf="proyecto.estadoRegistro === 'ACTIVO'"
              (click)="confirmToggleStatus(proyecto)"
              class="btn-icon btn-danger"
              title="Desactivar">
              <svg width="18" height="18" viewBox="0 0 18 18" fill="currentColor">
                <path fill-rule="evenodd" d="M5 3a2 2 0 012-2h4a2 2 0 012 2v1h3a1 1 0 110 2h-1v9a2 2 0 01-2 2H5a2 2 0 01-2-2V6H2a1 1 0 010-2h3V3zm2 0h4v1H7V3zm1 4a1 1 0 011 1v5a1 1 0 11-2 0V8a1 1 0 011-1zm4 0a1 1 0 011 1v5a1 1 0 11-2 0V8a1 1 0 011-1z" clip-rule="evenodd"/>
              </svg>
            </button>
            <button
              *ngIf="proyecto.estadoRegistro === 'INACTIVO'"
              (click)="confirmToggleStatus(proyecto)"
              class="btn-icon btn-success"
              title="Restaurar">
              <svg width="18" height="18" viewBox="0 0 18 18" fill="currentColor">
                <path fill-rule="evenodd" d="M15.707 5.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-3-3a1 1 0 111.414-1.414L8 11.586l6.293-6.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
              </svg>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Modal de Detalles de Proyecto -->
<div *ngIf="showDetailsModal" class="modal-overlay" (click)="closeDetails()">
  <div class="modal-content modal-details" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Detalles del Proyecto</h2>
      <button (click)="closeDetails()" class="close-btn">×</button>
    </div>
    <div class="modal-body" *ngIf="selectedProyecto">
      <p><strong>Título:</strong> {{ selectedProyecto.titulo }}</p>
      <p><strong>Descripción:</strong> {{ selectedProyecto.descripcion }}</p>
      <p><strong>Asignación:</strong> {{ selectedProyecto.fechaAsignacion }}</p>
      <p><strong>Límite:</strong> {{ selectedProyecto.fechaLimite }}</p>
      <p><strong>Estado:</strong> {{ selectedProyecto.estado }}</p>
      <div>
        <strong>Trabajadores:</strong>
        <div *ngIf="selectedProyecto.trabajadores?.length; else sinTrabajadores">
          <ul>
            <li *ngFor="let trabajador of selectedProyecto.trabajadores">
              {{ trabajador.nombre }} {{ trabajador.apellido }} - {{ trabajador.cargo }}
            </li>
          </ul>
        </div>
        <ng-template #sinTrabajadores>
          <span *ngIf="selectedProyecto.trabajador">
            {{ selectedProyecto.trabajador.nombre }} {{ selectedProyecto.trabajador.apellido }} - {{ selectedProyecto.trabajador.cargo }}
          </span>
          <span *ngIf="!selectedProyecto.trabajador">Sin asignar</span>
        </ng-template>
      </div>
    </div>
    <div class="modal-footer">
      <button (click)="closeDetails()" class="btn btn-secondary">Cerrar</button>
    </div>
  </div>
</div>

<!-- Modal de Asignar Trabajador -->
<div *ngIf="showAssignModal" class="modal-overlay" (click)="cancelAssign()">
  <div class="modal-content modal-assign" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Asignar Trabajador</h2>
      <button (click)="cancelAssign()" class="close-btn">×</button>
    </div>
    <div class="modal-body">
      <p *ngIf="assignProyecto"><strong>Proyecto:</strong> {{ assignProyecto.titulo }}</p>
      <div class="form-group">
        <label>Trabajadores (máx 3)</label>
        <div class="assign-list">
          <label *ngFor="let trabajador of trabajadoresDisponibles" class="assign-item">
            <input
              type="checkbox"
              [checked]="isAssignTrabajadorSeleccionado(trabajador.id)"
              (change)="toggleAssignTrabajador(trabajador.id)"
            />
            <span>{{ trabajador.nombre }} {{ trabajador.apellido }} - {{ trabajador.cargo }}</span>
          </label>
        </div>
      </div>
      <div *ngIf="assignError" class="message message-error">{{ assignError }}</div>
      <div *ngIf="assignSuccess" class="message message-success">{{ assignSuccess }}</div>
    </div>
    <div class="modal-footer">
      <button (click)="cancelAssign()" class="btn btn-secondary">Cancelar</button>
      <button (click)="confirmAssign()" class="btn btn-primary">Asignar</button>
    </div>
  </div>
</div>

<!-- Modal de Confirmación -->
<div *ngIf="showToggleConfirm" class="modal-overlay" (click)="cancelToggle()">
  <div class="modal-content modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ proyectoToToggle?.estadoRegistro === 'ACTIVO' ? 'Confirmar Desactivación' : 'Confirmar Restauración' }}</h2>
      <button (click)="cancelToggle()" class="close-btn">×</button>
    </div>
    <div class="modal-body">
      <p>¿Estás seguro de que deseas {{ proyectoToToggle?.estadoRegistro === 'ACTIVO' ? 'desactivar' : 'restaurar' }} el proyecto <strong>"{{ proyectoToToggle?.titulo }}"</strong>?</p>
    </div>
    <div class="modal-footer">
      <button (click)="cancelToggle()" class="btn btn-secondary">Cancelar</button>
      <button
        (click)="toggleStatus()"
        [ngClass]="proyectoToToggle?.estadoRegistro === 'ACTIVO' ? 'btn btn-danger' : 'btn btn-success'">
        {{ proyectoToToggle?.estadoRegistro === 'ACTIVO' ? 'Desactivar' : 'Restaurar' }}
      </button>
    </div>
  </div>
</div>

<!-- Modal de Éxito -->
<div *ngIf="showSuccessModal" class="modal-overlay">
  <div class="modal-content modal-small success-modal">
    <div class="modal-body text-center">
      <div class="success-icon">
        <svg width="60" height="60" viewBox="0 0 60 60" fill="currentColor">
          <circle cx="30" cy="30" r="28" fill="#10b981"/>
          <path d="M20 30 L26 36 L40 22" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
        </svg>
      </div>
      <h3>{{ successMessage }}</h3>
    </div>
  </div>
</div>
